# 自走牌游戏 — 开发文档

基于 [Core.md](../Core.md) 的完整技术设计与实现指南。

---

## 1. 项目概述

**定位**：异步 PvP + Roguelike + 卡牌 + 自动战斗 + 基于英雄的构筑。

**技术栈**：
- **前端**：H5 + Pixi.js + TypeScript
- **后端**：Node.js + TypeScript + MongoDB

---

## 2. 架构总览

```
AutoCard/
├── client/                 # 前端 (Pixi.js + TS)
│   ├── src/
│   │   ├── core/           # 游戏核心、循环、状态
│   │   ├── scenes/        # 场景（大厅、战斗、商店等）
│   │   ├── systems/       # 端口系统、战斗结算、经济
│   │   ├── ui/            # 通用 UI 组件
│   │   └── api/           # 与后端通信
│   └── ...
├── server/                 # 后端 (Node.js + TS)
│   ├── src/
│   │   ├── api/            # REST/WebSocket 路由
│   │   ├── services/       # 业务逻辑（登录, 匹配镜像对手）
│   │   ├── models/        # MongoDB 模型
│   │   └── game/          # 游戏规则、结算、镜像
│   └── ...
└── shared/                 # 前后端共享类型与常量（可选）
    └── types/
```

---

## 3. 核心系统设计

### 3.1 游戏循环与天数/小时

- **单位**：1 天 = 6 个行动点（小时）。
- **小时 1、2、4、5**：日常运营 — 三选一（商店 / 随机事件 / 免费礼物）。
- **小时 3**：PvE 野怪 — 三选一难度，结算 XP + 金币，胜方额外获得怪物技能/道具。
- **小时 6**：PvP 镜像战 — 与同段位玩家镜像异步对战。


### 3.2 胜负与声望

- **胜利条件**：累计 **10 场 PvP 胜利**（吃鸡）。
- **声望 (Prestige)**：初始 20；PvP 失败时扣除 **当前天数** 点（如第 3 天失败扣 3）。
- **失败条件**：声望 ≤ 0 则对局结束。

需持久化：`pvpWins`、`prestige`、`currentDay`。

### 3.3 空间与背包

- **棋盘 (Board / Rug)**：10 格。
- **储物箱 (Stash)**：10 格。
- **物品体积**：Small(1)、Medium(2)、Large(3)。
- **升阶**：两个**同 Tier** 的**相同物品**合并 → 上一 Tier（如两青铜 → 一白银）。

**数据要点**：
- 每格记录：`itemId`、`tier`、`size`、占格索引。
- 放置/合并时校验：总占用 ≤ 10，且不重叠。

### 3.4 端口化构筑 (Port-based Build)

**端口类型**：
- **输出端 (Output)**：Damage、Poison、Burn 等。
- **运转端 (Operational)**：Haste、Charge、Slow、Freeze 等。
- **防御端 (Defense)**：Heal、Shield 等。

**设计要点**：
- 卡牌/物品配置表需带 `ports: Output[] | Operational[] | Defense[]` 及触发条件。
- 存在“终端牌”（核心输出），其余牌通过“运转端”多次触发为其服务（如加速→充能→剧毒）。
- 前端：悬停时用蓝色边框标出受影响的相邻格/装备，便于摆位。

### 3.5 位置与跨界

- **位置规则**：部分效果带方向/相邻约束（如“最左侧武器 + 伤害”）。需在配置与结算时支持“相邻/方向”查询。
- **跨界**：通过事件/商店/野怪掉落可获得他职业/野怪技能，实现跨体系端口组合。配置上需支持“来源”与“可装备角色”。

### 3.6 等级与经济

- **XP**：每次行动 +1 XP（除非说明否则默认）；**每 8 XP 升级**。
- **升级收益**：最大血量提升、前期解锁棋盘格、随机技能/物品升级选择。
- **经济**：商店刷新成本按稀有度（如 2～8 金币）；需规划购买/刷新/存钱。

---

## 4. 数据模型 (MongoDB)

### 4.1 用户与对局

```ts
// User（可扩展）
interface User {
  _id: ObjectId;
  openId?: string;        // 登录态
  nickname: string;
  createdAt: Date;
}

// Run = 单局游戏
interface Run {
  _id: ObjectId;
  userId: ObjectId;
  heroId: string;
  status: 'active' | 'finished_win' | 'finished_lose';
  day: number;
  hour: number;
  prestige: number;
  pvpWins: number;
  xp: number;
  level: number;
  gold: number;
  board: SlotItem[];      // 棋盘 10 格
  stash: SlotItem[];      // 储物 10 格
  createdAt: Date;
  updatedAt: Date;
}

interface SlotItem {
  itemId: string;
  tier: 'bronze' | 'silver' | 'gold' | 'diamond';
  size: 1 | 2 | 3;
  slotIndex: number;      // 占用的起始格
}
```

### 4.2 镜像与 PvP

```ts
// 用于 PvP 的镜像快照（按段位/天等维度存储或按 run 存）
interface PvpMirror {
  runId: ObjectId;
  userId: ObjectId;
  day: number;
  tier: string;           // 段位
  snapshot: {
    level: number;
    board: SlotItem[];
    heroId: string;
    // 其他战斗所需
  };
  createdAt: Date;
}
```

### 4.3 配置表（可 MongoDB 或 JSON 导入）

- **Items**：itemId、name、size、tier、ports、效果参数、价格等。
- **Heroes**：heroId、初始属性、可选技能池。
- **Events**：事件 id、选项、奖励/惩罚。
- **Monsters**：难度、奖励（XP、金币、专属技能/道具）。

---

## 5. API 设计要点

### 5.1 对局流程

- `POST /run/start` — 用当前英雄开新局，返回 `Run`。
- `GET /run/current` — 当前进行中的 Run。
- `POST /run/hour-choice` — 提交第 1/2/4/5 小时的选择（商店/事件/礼物）。
- `POST /run/pve` — 选择野怪难度，服务端结算，返回奖励与状态。
- `POST /run/pvp` — 请求匹配镜像并结算 PvP，返回胜负、声望变化、是否达成 10 胜。

### 5.2 棋盘与背包

- `POST /run/board/place` — 放置/移动物品（含合并规则校验）。
- `POST /run/board/merge` — 合并两个同 Tier 同物品（服务端校验并更新 Run）。

### 5.3 配置与镜像

- `GET /config/items`、`/config/heroes`、`/config/events`、`/config/monsters` — 拉取配置。
- 镜像：在 `Hour6` 前根据 run 的 day/tier 生成或获取 `PvpMirror`，供他人匹配。

---

## 6. 前端模块 (Pixi.js + TS)

### 6.1 场景划分

- **Lobby**：选英雄、开始对局、历史。
- **Main**：每日 6 小时总览、当前小时选项（3 选 1 或野怪 3 选 1 或 PvP）。
- **Shop**：商店列表、刷新、购买、背包放置预览。
- **Board**：棋盘/储物箱拖拽、高亮相邻与端口影响（蓝色边框）、合并确认。
- **Battle**：PvE/PvP 自动战斗演出与结果（可先做简化版数值结算）。

### 6.2 与后端同步

- 所有改变 Run 状态的操作（选小时、PvE、PvP、放置、合并）均通过 API 完成，前端以服务端返回为权威。
- 可对当前 Run 做本地缓存，每次操作后替换并重绘。

### 6.3 端口与摆位反馈

- 物品配置中包含 `ports` 与目标条件（如“左侧武器”）。
- 悬停某物品时，根据规则计算受影响的格子/装备，用 Pixi 图形（如蓝色描边）高亮。

---

## 7. 后端模块 (Node.js + TS)

### 7.1 服务分层

- **Route**：解析参数，调用 Service，返回 JSON。
- **Service**：对局状态变更、经济、战斗结算、镜像生成。
- **Model**：Mongoose 等封装 Run、User、PvpMirror、Config。

### 7.2 战斗与结算

- **PvE**：根据难度与当前 Run 的 board/level 做数值结算（可先公式化），判定胜负，发奖（XP、金币、专属掉落）。
- **PvP**：取对方镜像 snapshot，与当前 Run 的 snapshot 做自动战斗结算（同套公式或简化版），判定胜负，更新 `pvpWins`、`prestige`，检查是否 10 胜或声望≤0。

### 7.3 镜像策略

- 在进入第 6 小时或每日结束时，将当前 Run 的 board/level/hero 等写入 `PvpMirror`（按段位+天等维度），供其他玩家匹配。

---

## 8. 开发约定

- **语言**：前后端统一 TypeScript，严格类型。
- **接口**：REST + 必要时 WebSocket（如实时战斗观战）；先实现 REST 即可。
- **配置**：物品/英雄/事件/怪物用 ID 引用，便于热更与扩展。
- **安全**：所有改 Run 的接口需校验 `userId` 与 `runId` 归属，防止越权。

---

## 9. 扩展与后续

- 段位与匹配规则细化（如按 day 或 MMR 匹配）。
- 完整战斗公式与技能/端口触发顺序。
- 存档与多 Run 管理（当前仅“当前 Run”也可先跑通）。
- 数据统计与平衡性配置（掉落率、商店刷新成本等）。

---

本文档与 [Core.md](../Core.md) 对齐，可直接作为实现与评审依据。具体接口路径、字段名和项目目录可按实际微调。
