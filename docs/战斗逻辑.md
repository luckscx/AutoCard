# 战斗逻辑详细设计

## 一、战斗触发时机

| 小时 | 类型 | 说明 |
|------|------|------|
| 3 | PvE | 玩家从简单/中等/困难三档怪物中选一个战斗 |
| 6 | PvP | 与其他玩家的异步镜像（或 AI 对手）自动对战 |

## 二、战斗参与者数据结构

```typescript
interface Combatant {
  hp: number;       // 当前血量
  maxHp: number;    // 最大血量（治疗不超过此值）
  level: number;    // 等级
  board: SlotItem[]; // 棋盘上的卡牌列表
}
```

每张卡牌 `SlotItem` 包含：
- `itemId` — 对应 ItemConfig，决定端口效果和冷却
- `tier` — bronze / silver / gold / diamond，影响效果数值倍率
- `size` — 1/2/3，影响占位但不影响战斗
- `slotIndex` — 在棋盘上的位置（0-9），影响 targetRule 的相邻/最左/最右判定

## 三、卡牌类别体系 (Kind)

每张卡牌除了 size（小/中/大）外，还拥有一个或多个 **类别标签 (Kind)**。Kind 是构筑联动和被动效果触发的核心依据。

### 3.0.1 类别列表

类别分为两大类：**主题类别**（决定卡牌属于什么阵营/流派）和 **特性类别**（描述卡牌具有的属性特征）。

**主题类别（阵营 / 流派）**：

| Kind | 说明 |
|------|------|
| `weapon` 武器 | 主要输出手段，剑、匕首、法杖等 |
| `apparel` 服饰 | 穿戴类装备，通常带防御或辅助效果 |
| `aquatic` 水系 | 水属性卡牌，可能与冰冻、减速联动 |
| `core` 核心 | 构筑的核心终端牌，通常是高价值输出端 |
| `dinosaur` 恐龙 | 恐龙系卡牌，高攻击力大型单位 |
| `dragon` 龙 | 龙系卡牌，灼烧联动 |
| `drone` 无人机 | 科技系辅助，通常为运转端 |
| `food` 食物 | 消耗类，治疗/buff |
| `loot` 战利品 | 来自怪物掉落的特殊卡牌 |
| `potion` 药水 | 消耗类，恢复/增益效果 |
| `tool` 工具 | 多用途卡牌，辅助构筑 |
| `property` 地产 | 经济型卡牌，可能提供收入 |
| `ray` 射线 | 远程输出类型 |
| `relic` 遗物 | 稀有卡牌，通常有独特被动效果 |
| `tech` 科技 | 科技系卡牌，与无人机等联动 |
| `vehicle` 载具 | 大型载具类卡牌 |
| `material` 原料 | 基础材料，用于合成或提供被动加成 |
| `ammo` 弹药 | 为武器类卡牌提供额外触发或伤害 |
| `toy` 玩具 | 趣味类卡牌，有意外的联动效果 |
| `companion` 伙伴 | 跟随类卡牌，提供持续辅助效果 |
| `flight` 飞行 | 飞行特性，可能有位置优势 |

**特性类别（效果属性标签）**：

一张卡牌可以同时携带与其端口效果对应的特性标签：

| Kind | 对应效果 | 说明 |
|------|----------|------|
| `poison` 剧毒 | poison 端口 | 拥有剧毒效果的卡牌 |
| `burn` 灼烧 | burn 端口 | 拥有灼烧效果的卡牌 |
| `freeze` 冰冻 | freeze 端口 | 拥有冰冻效果的卡牌 |
| `shield` 护盾 | shield 端口 | 拥有护盾效果的卡牌 |

**体积类别**：

| Kind | 说明 |
|------|------|
| `small` 小型 | 占 1 格 |
| `medium` 中型 | 占 2 格 |
| `large` 大型 | 占 3 格 |

### 3.0.2 Kind 的作用

1. **被动效果触发条件**：很多卡牌的被动效果以 Kind 为条件。例如"当相邻卡牌是武器时，为其增加伤害"、"每拥有一张龙类卡牌，灼烧值 +2"。
2. **构筑流派引导**：Kind 决定了卡牌之间的协同方向，玩家围绕特定 Kind 构建阵容可获得大量联动收益。
3. **商店刷新池**：不同英雄的商店可能更倾向于刷出其对应 Kind 的卡牌。
4. **事件/怪物掉落**：某些怪物只掉落特定 Kind 的卡牌（如击败龙类怪物掉落龙系卡牌）。

### 3.0.3 数据结构

```typescript
// ItemConfig 中的 kinds 字段
interface ItemConfig {
  itemId: string;
  name: string;
  kinds: string[];   // 类别标签数组，如 ['weapon', 'dragon', 'burn']
  // ... 其他字段
}
```

一张卡牌可同时拥有多个 Kind。例如"龙焰巨剑"可以是 `['weapon', 'dragon', 'burn', 'large']`。

## 四、卡牌效果体系

### 4.1 端口分类

| 分类 | 类型 | 说明 |
|------|------|------|
| **输出端 output** | `damage` | 直接伤害，先扣护盾再扣血 |
| | `poison` | 叠加剧毒，每秒持续扣血，**不递减** |
| | `burn` | 叠加灼烧，每秒扣血，**每秒递减 1 层** |
| | `destroy` | 摧毁敌方指定卡牌，使其从战斗中移除 |
| **运转端 operational** | `haste` | 加速，持续 value 秒，期间目标卡牌充能速度翻倍 |
| | `charge` | 充能，一次性减少目标卡牌 value 秒的冷却，可过充连续触发 |
| | `slow` | 减速，持续 value 秒，期间敌方目标卡牌充能速度减半 |
| | `freeze` | 冰冻，持续 value 秒，期间敌方目标卡牌完全无法充能 |
| **防御端 defense** | `heal` | 治疗自身，不超过 maxHp |
| | `shield` | 叠加护盾，可累积，能抵挡 damage（**不能防 poison/burn**） |

### 4.2 目标规则 (targetRule)

决定一张卡牌的端口效果作用于谁：

| kind | 作用目标 |
|------|----------|
| `self` | 只作用于自身玩家（输出端作用于对手） |
| `adjacent` | 作用于棋盘上相邻位置的卡牌 |
| `leftmost` | 作用于棋盘最左侧的卡牌 |
| `rightmost` | 作用于棋盘最右侧的卡牌 |
| `all` | 作用于己方所有卡牌 |
| `position` | 指定位置 index 的卡牌 |

> **位置对战斗极其重要**：相邻联动是核心构筑逻辑。例如"战号角"(haste, adjacent) 放在"铁剑"旁边可加速铁剑触发。

### 4.3 摧毁 (destroy) 效果细节

- 触发时移除敌方指定位置的卡牌，使其在本场战斗中完全失效
- 根据 targetRule 确定摧毁哪张卡（如 leftmost = 摧毁敌方最左侧卡牌）
- 被摧毁的卡牌不再充能和触发，但战斗结束后不影响实际棋盘（仅战斗内生效）
- 如果目标位置没有卡牌，效果浪费

### 4.4 品阶倍率

| 品阶 | 数值倍率 |
|------|----------|
| bronze 青铜 | ×1.0 |
| silver 白银 | ×1.5 |
| gold 黄金 | ×2.2 |
| diamond 钻石 | ×3.0 |
| legendary 传奇 | ×4.0 |

最终效果值 = `Math.round(port.value × tierMultiplier)`

### 4.5 暴击率 (critRate)

卡牌可拥有暴击率属性：
- 每次触发端口效果时，有 `critRate%` 的概率暴击
- 暴击时效果值 ×2
- 最终值 = `Math.round(port.value × tierMultiplier × (isCrit ? 2 : 1))`
- 暴击率范围 0-100，默认 0（不暴击）

### 4.6 角色扩展数值

除 HP / MaxHP / Gold 外，角色还有以下战斗相关数值：

| 属性 | 说明 |
|------|------|
| `income` 收入 | 每天结束时自动获得的金币数，基础为 0，可被卡牌/事件增加 |
| `hpRegen` 生命再生 | 每场战斗结束后自动回复的 HP 量 |
| `goldGainBonus` 金币获取加成 | 所有金币获取来源的额外加成量 |

## 五、战斗流程（当前后端实现）

### 5.1 回合制模拟（简化版）

当前 `server/src/game/battle.ts` 实现为 **回合制简化模拟**：

```
初始化: aShield=0, dShield=0, aPoison=0, dPoison=0, aBurn=0, dBurn=0
MAX_ROUNDS = 30

每回合 round (0 ~ 29):
  1. 毒/烧结算
     - 双方 HP 分别扣除自身的 poison + burn
     - poison 每回合减 1（当前实现）
     - burn 每回合减 1
  2. 检查是否有一方 HP ≤ 0
  3. 攻击者所有卡牌触发：
     - 判定 round % cooldown === 0 时触发
     - 按端口类型执行效果
  4. 检查防守方 HP
  5. 防守者所有卡牌触发（同上逻辑）
  6. 检查攻击方 HP

30 回合后仍未结束: HP 高者获胜
```

### 5.2 PvE 战斗

怪物没有真实卡牌，而是用一个虚拟卡牌 `__monster_attack` 模拟：
- 每 2 回合触发一次
- 伤害值 = 怪物配置的 `attack` 值
- 战斗结果决定 XP / 金币 / 掉落物

三档怪物属性范围：

| 难度 | HP | 攻击力 | XP奖励 | 金币 | 掉落 |
|------|-----|--------|--------|------|------|
| easy | 35-40 | 5-8 | 1 | 3-4 | 常见道具 40% |
| medium | 70-100 | 10-12 | 2 | 5-6 | 稀有道具 15-35% |
| hard | 120-150 | 20-25 | 3 | 8-10 | 高级道具 10-25% |

### 5.3 PvP 镜像战

1. 保存自己当前状态到 `PvpMirror` 集合
2. 查找同天数（±1天）的其他玩家镜像，无则生成 AI 对手
3. 执行 `resolveBattle(玩家, 对手)`
4. 胜利：pvpWins+1，金币+3；累计 10 胜则通关
5. 失败：金币+1，声望扣除当前天数；声望归零则游戏结束

## 六、待实现：基于时间轴的实时战斗引擎

### 6.1 设计目标

将当前回合制改为 **基于秒的时间轴系统**，更贴近文档描述的核心玩法：

### 6.2 时间轴战斗流程

```
战斗总时长上限: 20秒
时间精度: 0.1秒 (100ms tick)

初始化:
  - 双方所有卡牌设置 currentCooldown = 0
  - 全局状态: playerHp, enemyHp, shields, poison, burn, frozen卡牌列表

每 tick (0.1秒):
  1. DoT 结算（每秒结算一次，即每 10 tick）
     - poison: 每秒扣 poisonStack 点血（不递减）
     - burn: 每秒扣 burnStack 点血（每秒递减 1 层）
  2. 遍历双方所有卡牌:
     - 如果被冰冻 (freezeRemain > 0): 完全跳过充能，freezeRemain -= 0.1s
     - 否则计算充能增量:
       - baseCharge = 0.1s
       - 如果 hasteRemain > 0: baseCharge × 2，hasteRemain -= 0.1s
       - 如果 slowRemain > 0: baseCharge × 0.5，slowRemain -= 0.1s
       - haste + slow 同时存在时先加速再减速 (0.1 × 2 × 0.5 = 0.1)
     - currentCooldown += baseCharge
     - while currentCooldown >= card.cooldown:  (循环处理过充)
       - 触发该卡牌的所有端口效果
       - currentCooldown -= card.cooldown  (保留溢出部分，继续下一轮CD)
  3. 检查双方 HP
  4. 如果 elapsed > 20秒: 触发全局递增扣血（overtime机制）
     - 每秒对双方各扣 (elapsed - 20) 点血，逐秒递增
```

### 6.3 效果执行细节

**damage**：
- `realDamage = max(0, value - targetShield)`
- `targetShield = max(0, targetShield - value)`
- `targetHp -= realDamage`

**poison**：
- `targetPoisonStack += value`
- 每秒扣 `poisonStack` 点血
- **不自然递减**，只能通过净化效果移除

**burn**：
- `targetBurnStack += value`
- 每秒扣 `burnStack` 点血
- **每秒自动递减 1 层**

**shield**：
- `selfShield += value`
- 可累积，无上限
- 只能抵挡 damage，不能防 poison / burn

**heal**：
- `selfHp = min(selfHp + value, selfMaxHp)`

**haste**：
- 给目标卡牌施加加速 buff，`targetCard.hasteRemain += value` 秒
- 加速期间充能速度 ×2（每 tick 充能 0.2s 而非 0.1s）
- 根据 targetRule 确定加速哪张卡
- 可叠加持续时间，不叠加倍率

**charge**：
- 一次性给目标卡牌的 `currentCooldown += value` 秒
- **支持过充**：如果充能后 currentCooldown ≥ cooldown，立即触发效果并扣除一个 cooldown，剩余溢出量继续计入下一轮 CD
- 例：卡牌 CD=3s，当前已充 2s，charge(2) → 充到 4s → 触发一次，剩余 1s 进入下一轮
- 根据 targetRule 确定充能哪张卡

**slow**：
- 给敌方目标卡牌施加减速 debuff，`targetCard.slowRemain += value` 秒
- 减速期间充能速度 ×0.5（每 tick 充能 0.05s 而非 0.1s）
- haste 的反向操作，两者同时存在时互相抵消（×2 × ×0.5 = ×1）
- 根据 targetRule 确定减速哪张卡
- 可叠加持续时间，不叠加倍率

**freeze**：
- 冰冻敌方目标卡牌，`targetCard.freezeRemain += value` 秒
- 冰冻期间该卡牌 **完全无法充能**，充能进度冻结
- 冰冻结束后从当前充能进度继续
- 根据 targetRule 确定冰冻哪张卡
- 可叠加持续时间

### 6.4 超时全局扣血

超过 20 秒后，进入 overtime 阶段：
- 每秒对双方各扣 `(当前秒 - 20)` 点血
- 第 21 秒扣 1，第 22 秒扣 2，以此类推
- 确保战斗不会无限拖延

### 6.5 战斗结果数据

```typescript
interface BattleResult {
  won: boolean;          // 玩家是否获胜
  hpLeft: number;        // 玩家剩余 HP
  xpGained: number;      // 获得经验
  goldGained: number;     // 获得金币
  loot?: string[];        // 掉落物品 ID（PvE）
}
```

### 6.6 战斗日志（用于前端回放）

后端应生成完整的战斗事件日志，供前端逐帧回放：

```typescript
interface BattleEvent {
  tick: number;           // 发生在第几个 tick (0.1秒精度)
  source: 'player' | 'enemy';
  cardSlotIndex: number;  // 触发的卡牌位置
  effects: BattleEffectEntry[];
}

interface BattleEffectEntry {
  type: 'damage' | 'poison' | 'burn' | 'heal' | 'shield' | 'freeze' | 'haste' | 'slow' | 'charge';
  value: number;
  target: 'player' | 'enemy' | 'card';  // card 表示作用于某张卡牌
  targetCardIndex?: number;              // 被作用的卡牌位置
}

interface BattleSnapshot {
  tick: number;
  playerHp: number;
  enemyHp: number;
  playerShield: number;
  enemyShield: number;
  playerPoison: number;
  enemyPoison: number;
  playerBurn: number;
  enemyBurn: number;
}
```

后端返回：`{ result: BattleResult, events: BattleEvent[], snapshots: BattleSnapshot[] }`

## 七、前端战斗演出

### 7.1 战斗界面布局

采用四区域布局：
- **Z1**：战斗信息（PvE 怪物名 / PvP 对手信息）
- **Z2**：敌方棋盘卡牌
- **Z3**：玩家棋盘卡牌
- **Z4**：底部信息栏

### 7.2 卡牌冷却动画

每张卡牌上叠加一个 **光柱进度条** 动画：
- 从卡牌底部向顶部推进的半透明光柱
- 推满 = 触发效果 → 光柱重置
- 光柱速度受 haste/slow 影响
- 冰冻时光柱暂停，卡牌显示冰冻特效（蓝色半透明覆盖）

### 7.3 效果展示

| 效果 | 展示方式 |
|------|----------|
| damage | 敌方 HP 条闪红，浮出红色「-N」数字 |
| poison | 敌方角色区域浮出绿色「毒 +N」，HP 条变绿 |
| burn | 敌方角色区域浮出橙色「烧 +N」，火焰粒子 |
| heal | 己方 HP 条闪绿，浮出绿色「+N」 |
| shield | 己方出现蓝色护盾数值「盾 +N」 |
| freeze | 被冰冻卡牌覆盖蓝色冰晶效果 |
| haste | 被加速卡牌光柱推进速度 ×2，黄色边框发光，持续到 buff 结束 |
| slow | 被减速卡牌光柱推进速度 ×0.5，灰色迟缓标记，持续到 debuff 结束 |
| charge | 目标卡牌光柱瞬间跳跃前进，若过充则连续触发闪光 |

### 7.4 全局状态面板

在 Z1 区域实时显示双方状态：
```
玩家 HP: ████████░░ 80/100   护盾: 15   毒: 3/秒   烧: 2/秒
敌方 HP: ██████░░░░ 60/100   护盾: 0    毒: 8/秒   烧: 0/秒
```

### 7.5 超时提示

超过 20 秒后：
- 屏幕边缘出现红色脉冲警告
- 中央浮出「OVERTIME! 全局扣血中...」
- 扣血数字同时在双方 HP 条上显示

### 7.6 战斗结束

- 一方 HP 归零时冻结画面
- 弹出结果面板（胜利/失败 + 奖励详情）
- 点击「继续」返回 MainScene

## 八、前后端交互流程

```
客户端                          服务端
  |                               |
  |-- POST /run/pve (difficulty)--|
  |   或 POST /run/pvp           |
  |                               |-- 执行战斗引擎
  |                               |-- 生成 events + snapshots
  |                               |-- 计算 BattleResult
  |                               |-- 更新 run 状态 (HP/Gold/XP)
  |<-- { result, events,       --|
  |      snapshots, opponent }    |
  |                               |
  |-- 前端根据 events 逐帧回放 --|
  |-- 战斗演出完成 → 显示结果   --|
  |-- 点击继续 → 回到 MainScene --|
```

## 九、当前状态 vs 目标状态

| 模块 | 当前状态 | 目标状态 |
|------|----------|----------|
| 后端战斗引擎 | 回合制简化模拟（30回合） | 基于 tick 的时间轴系统（0.1s精度） |
| haste/slow/freeze/charge | 占位空实现 | haste/slow 为持续性 buff/debuff 影响充能速率；charge 一次性减CD支持过充；freeze 持续冻结充能 |
| destroy (摧毁) | 未实现 | 战斗中移除敌方指定卡牌 |
| targetRule | 未在战斗中使用 | 完整实现相邻/最左/最右/全体定位 |
| 卡牌 Kind (类别) | 使用 tags 字段，类别不完整 | 完整的 kinds 字段，28 种类别标签，支持被动联动触发 |
| 暴击率 (critRate) | 未实现 | 每次触发有概率暴击，效果 ×2 |
| 传奇品阶 | 仅支持 bronze/silver/gold/diamond | 新增 legendary 品阶，倍率 ×4.0 |
| 角色扩展属性 | 仅 HP/Gold/Prestige | 新增 income (收入)、hpRegen (生命再生)、goldGainBonus (金币获取加成) |
| 战斗日志 | 无 | 生成 events + snapshots 供前端回放 |
| 前端战斗演出 | 直接显示结果面板 | 逐帧回放战斗过程 + 卡牌动画 + 伤害数字 |
| DoT (poison/burn) | 每回合各减 1 | poison 不递减，burn 每秒减 1 |
| 超时扣血 | 无 | 20 秒后全局递增扣血 |
| PvE 怪物 | 用虚拟单卡模拟 | 可配置怪物专属卡牌组合 |
